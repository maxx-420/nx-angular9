<mat-card
  *ngIf="!isLoading"
  class="app-card"
  class="mat-elevation-z0 mode-breakdown-card"
>
  <mat-card-header *ngIf="title" class="no-wrap">
    <mat-card-title>
      <div class="exception-msg-container">
        <h3 class="h4 card-header">
          <span [attr.data-automation]="'mode_breakdown_header'">{{
            title | content
          }}</span>
          <span
            *ngIf="config?.data?.totalcustomerCharge"
            [attr.data-automation]="'mode_breakdown_currency'"
          >
            {{ config?.data?.totalcustomerChargeCurrency || "" }}
          </span>
          <lib-learn-more
            [learnMoreType]="LearnMoreTypes.MultiColumn"
            [toggleTypes]="toggleTypes"
            [modalTitle]="learnMoreModalTitle"
            [tableTitle]="learnMoreModalTitle?.split('-')[0].trim()"
            [modalData]="learnMoreData"
            [attrToFetchData]="attributesToFetchData"
            [contentHtmlKey]="contentHtmlKey"
            pageSection="Financial Tab"
            [hasApiFailed]="config?.hasApiFailed"
            errorReason="Financial Summary Api Failed"
            [customLabelMapping]="labelCustomMappingModal"
            [isTableRowClickable]="true"
            [isTableColumnClickable]="false"
            [dataAutomationAttr]="'mode_breakdown_card-learn-more'"
            (tableRowClicked)="onLearnMoreRowClick($event)"
          ></lib-learn-more>
        </h3>
      </div>
    </mat-card-title>
  </mat-card-header>
  <mat-card-content class="mb-0">
    <div class="body5 mode-breakdown-container">
      <ng-container
        [ngTemplateOutlet]="modeBreakdownTemplate"
        [ngTemplateOutletContext]="{
          financialModeBreakdownData: financialModeBreakdownData,
          config: config,
          headerColumns: headerColumns
        }"
      >
      </ng-container>
    </div>
  </mat-card-content>
</mat-card>

<!-- Loader -->
<div
  *ngIf="isLoading"
  class="loader sp-mb-20"
  [style]="{ height: '400px' }"
></div>

<ng-template
  #modeBreakdownTemplate
  let-financialModeBreakdownData="financialModeBreakdownData"
  let-config="config"
  let-headerColumns="headerColumns"
>
  <ng-container *ngIf="!config?.hasApiFailed; else errorTemplate">
    <ng-container
      *ngIf="financialModeBreakdownData?.length > 0; else noDataTemplate"
    >
      <div class="mode-breakdown">
        <ng-container *ngIf="!isMobile">
          <div class="d-flex flex-row mode-breakdown-header align-items-center">
            <div class="fin-data-width"></div>
            <div
              class="fin-data-width align-right"
              [attr.data-automation]="'fin-modes-th'"
            >
              {{ headerColumns[0] | content }}
            </div>
            <div
              class="fin-data-width align-right"
              [attr.data-automation]="'fin-modes-th'"
            >
              {{ headerColumns[1] | content }}
            </div>
            <div
              class="fin-data-width align-right"
              [attr.data-automation]="'fin-modes-th'"
            >
              {{ headerColumns[2] | content }}
            </div>
          </div>
          <div class="mode-breakdown-table">
            <div
              class="d-flex flex-row mode-breakdown-row align-items-center body-1"
              tabindex="0"
              *ngFor="let data of financialModeBreakdownData"
              (click)="onRowClick(data.shipmentMode)"
              (keyup.enter)="onRowClick(data.shipmentMode)"
            >
              <div
                class="fin-data-mode fin-data-width"
                [attr.data-automation]="'mode_breakdown_mode_name'"
              >
                {{ data.shipmentMode }}
              </div>
              <div
                class="fin-data-charge fin-data-width"
                [attr.data-automation]="'mode_breakdown-total-value'"
              >
                {{
                  data.totalcustomerCharge
                    ? data.totalcustomerCharge
                    : ("shpt_fin_modBrkDwn_na" | content)
                }}
              </div>
              <div class="fin-data fin-data-width d-flex align-items-center">
                <span [attr.data-automation]="'avg_value'">
                  {{
                    data.averageCostPerShipment
                      ? data.averageCostPerShipment
                      : ("shpt_fin_modBrkDwn_na" | content)
                  }}
                </span>
                <ng-container
                  [ngTemplateOutlet]="templates.get('percentTemplate')"
                  [ngTemplateOutletContext]="{
                    data: {
                      class: 'fin-data-percent',
                      percent: data.differenceOfAvgCostPerShipment,
                      dataAutomationAttr: 'avg_percent'
                    }
                  }"
                ></ng-container>
              </div>
              <!-- Avg Cost/Ship unit -->
              <div class="fin-data fin-data-width d-flex align-items-center">
                <span [attr.data-automation]="'cost_value'">
                  {{
                    data.averageCostPerUnit
                      ? data.averageCostPerUnit
                      : ("shpt_fin_modBrkDwn_na" | content)
                  }}
                </span>
                <ng-container
                  [ngTemplateOutlet]="templates.get('percentTemplate')"
                  [ngTemplateOutletContext]="{
                    data: {
                      class: 'fin-data-percent',
                      percent: data.differenceOfAvgCostPerUnit,
                      dataAutomationAttr: 'cost-percent'
                    }
                  }"
                ></ng-container>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="isMobile">
          <div
            class="mode-breakdown-row"
            *ngFor="let data of financialModeBreakdownData"
            (click)="onRowClick(data.shipmentMode)"
            (keyup.enter)="onRowClick(data.shipmentMode)"
          >
            <ng-container
              [ngTemplateOutlet]="modeRowTemplate"
              [ngTemplateOutletContext]="{
                rowdata: {
                  showPercent: false,
                  modeData: {
                    exact_label: data.shipmentMode,
                    value: data.totalcustomerCharge,
                    dataAttr_label: 'mode_breakdown_mode_name',
                    dataAttr_value: 'mode_breakdown_total_value',
                    class: 'emphasise'
                  },
                  percent: null
                }
              }"
            ></ng-container>
            <ng-container
              [ngTemplateOutlet]="modeRowTemplate"
              [ngTemplateOutletContext]="{
                rowdata: {
                  showPercent: true,
                  modeData: {
                    label: headerColumns[1],
                    value: data.averageCostPerShipment,
                    dataAttr_label: '',
                    dataAttr_value: 'avg_value',
                    class: ''
                  },
                  percent: data.differenceOfAvgCostPerShipment
                }
              }"
            ></ng-container>
            <ng-container
              [ngTemplateOutlet]="modeRowTemplate"
              [ngTemplateOutletContext]="{
                rowdata: {
                  showPercent: true,
                  modeData: {
                    label: headerColumns[2],
                    value: data.averageCostPerUnit,
                    dataAttr_label: '',
                    dataAttr_value: 'cost_value',
                    class: ''
                  },
                  percent: data.differenceOfAvgCostPerUnit
                }
              }"
            ></ng-container>
          </div>
        </ng-container>
      </div>

      <div class="mode-breakdown-status">
        <div
          class="status-line body-1 my-auto"
          [attr.data-automation]="'mode_breakdown_status'"
        >
          {{ xAxisDisclaimer | content }}
        </div>
      </div>
    </ng-container>
  </ng-container>
</ng-template>

<!-- No Data -->
<ng-template #noDataTemplate>
  <div class="no-chart-data" [style]="customStyle">
    <span class="no-data-icon-bg-small">
      <i class="symphony-icons symphony-icons-component-error no-data-icon"></i>
    </span>
    <span class="body2">{{ "lbl_data_not_available_chart" | content }}</span>
  </div>
</ng-template>

<!-- Error Template -->
<ng-template #errorTemplate>
  <lib-error
    variation="horizontal"
    [customStyle]="customStyle"
    errorReason="Financial Api Failed"
    pageSection="Financial"
  ></lib-error>
</ng-template>

<!--Mode template-->
<ng-template #modeRowTemplate let-data="rowdata">
  <div class="mode">
    <div
      class="mode_label"
      [ngClass]="data.modeData.class"
      [attr.data-automation]="data.modeData.dataAttr_label"
    >
      {{
        data.modeData.exact_label
          ? data.modeData.exact_label
          : (data.modeData.label | content)
      }}
    </div>
    <div
      class="mode_value"
      [ngClass]="data.modeData.class"
      [attr.data-automation]="data.modeData.dataAttr_value"
    >
      {{
        data.modeData.value
          ? data.modeData.value
          : ("shpt_fin_modBrkDwn_na" | content)
      }}
      <ng-container *ngIf="data.showPercent">
        <ng-container
          [ngTemplateOutlet]="percentTemplate"
          [ngTemplateOutletContext]="{
            data: {
              class: 'fin-data-percent',
              percent: data.percent
            }
          }"
        ></ng-container>
      </ng-container>
    </div>
  </div>
</ng-template>
