<button
  type="button"
  [libPopoverDirective]="tooltipTemplate"
  [clickTemplate]="menuContent"
  [showTooltip]="isMobileView ? false : true"
  [fullWidth]="isMobileView ? true : false"
  [popoverCloseOnScroll]="false"
  [popoverPositionsOnClick]="customPopoverPositions || popoverPositions"
  [addOverlayHostClass]="addOverlayHostClass"
  [closeMenuSubject]="closeMenu"
  (menuState)="isOpen = $event; accountSelectorToggle($event)"
  [ngClass]="[
    isProductLineHLD ? 'hld-menu-btn' : '',
    isMobileView ? 'hamburger-accounts-menu' : ''
  ]"
  [ngStyle]="accountToggleButtonStyling"
  class="menu-btn"
  [attr.aria-expanded]="isOpen"
  [attr.aria-label]="
    companyDetails?.name + ('dpf_hdr_acctSel_btnAria' | content)
  "
  (click)="isMenuOpen.emit(isOpen)"
>
  <ng-container *ngIf="!isMobileView">
    <div class="sub-menu-account-section">
      <span class="sub-menu-account-label menu-label">{{
        "lbl_subnav_viewingAs" | content
      }}</span>
      <div class="body4 active-account-name">
        {{ accountSelectorLabel }}
      </div>
    </div>
    <i
      class="symphony-icons symphony-icons-arrow-down"
      aria-hidden="true"
      [ngClass]="[isProductLineHLD ? 'menu-icon-color' : '']"
    ></i>
  </ng-container>

  <ng-container *ngIf="isMobileView">
    <div class="account-toggle">
      <span class="h7 menu-label account-label">{{
        "lbl_subnav_viewingAs" | content
      }}</span>
      <div class="sidenav-item">{{ accountSelectorLabel }}</div>
    </div>
    <i
      [ngClass]="[
        isOpen ? 'symphony-icons-arrow-up' : 'symphony-icons-arrow-down'
      ]"
      class="symphony-icons"
      aria-hidden="true"
    ></i>
  </ng-container>
</button>

<ng-template #menuContent>
  <form
    (keydown.enter)="$event.preventDefault()"
    role="form"
    [attr.aria-label]="'dpf_hdr_acctSel_frmAria ' | content"
    [formGroup]="actSelectorForm"
    class="menu-content popover"
    [ngClass]="[isMobileView ? 'hamburger' : '']"
  >
    <div
      class="slider"
      *ngIf="showSelectMultipleToggle && employeeAccount && !hideToggle"
    >
      <ng-container *ngTemplateOutlet="sliderTemplate"></ng-container>
    </div>

    <div class="search">
      <input
        formControlName="searchValue"
        attr.aria-label="{{ 'dpf_hdr_acctSel_srchPlcehldr' | content }}"
        class="search__input"
        placeholder="{{ 'dpf_hdr_acctSel_srchPlcehldr' | content }}"
      />
    </div>

    <lib-single-selection-list
      *ngIf="!multiAccountSelected && employeeAccount"
      [filterBy]="actSelectorForm?.get('searchValue')?.value"
      ngDefaultControl
      [list]="
        isSelectMultipleActive
          ? getFilteredList(companyGroupList)
          : getFilteredList(allCompanyList)
      "
      (selectedOption)="selectAccount($event)"
    ></lib-single-selection-list>
    <ng-container *ngIf="multiAccountSelected || !employeeAccount">
      <lib-multi-selection-list
        ngDefaultControl
        *ngIf="selectedAccount"
        formControlName="childAccounts"
        [listHeaderTitle]="selectedAccount?.name"
        [accountsList]="getFilteredList(selectedAccount?.children)"
        [filterBy]="actSelectorForm?.get('searchValue')?.value"
        [showBackButton]="employeeAccount"
        (backClicked)="onBackClick()"
      ></lib-multi-selection-list>
      <div class="section-bottom">
        <mat-checkbox
          *ngIf="!hideSetAsDefault"
          class="checkbox save-as-default-checkbox"
          formControlName="isDefaultUnit"
        >
          <span class="save-default">{{
            "lbl_save_as_default" | content
          }}</span>
        </mat-checkbox>
        <lib-button
          mat-flat-button
          className="update-button"
          [customStyle]="{ margin: '10px' }"
          [automationAttribute]="dataAutomationAttribute.updateButton"
          [disabled]="
            (actSelectorForm?.get('childAccounts')?.value?.length || 0) <
            (!employeeAccount ? 1 : 2)
          "
          color="primary"
          [getTextFromCMS]="false"
          (clickEvent)="
            setAccountSelected(
              actSelectorForm?.get('childAccounts')?.value,
              actSelectorForm?.get('isDefaultUnit')?.value
            )
          "
          text="({{
            actSelectorForm?.get('childAccounts')?.value?.length || 0
          }}) {{ 'lbl_update' | content }}"
        ></lib-button>
      </div>
    </ng-container>
  </form>
</ng-template>

<ng-template #sliderTemplate>
  <ng-container>
    <mat-slide-toggle
      id="account-selector-toggle"
      #mySlider
      [attr.data-automation]="dataAutomationAttribute.toggleButton"
      aria-label="{{
        (!isSelectMultipleActive
          ? 'dpf_hdr_acctSel_selectMulChckd'
          : 'dpf_hdr_acctSel_selectMulNotChckd'
        ) | content
      }}
      "
      [(ngModel)]="isSelectMultipleActive"
      (change)="toggleChange($event)"
    >
      <span
        [attr.data-automation]="dataAutomationAttribute.toggleButtonLabel"
        class="slider__title"
        >{{ "dpf_hdr_acctSel_slctMul" | content }}</span
      >
    </mat-slide-toggle>
  </ng-container>
</ng-template>

<ng-template #tooltipTemplate>
  <lib-tooltip
    *ngIf="companyDetails?.length > 1"
    [content]="selectedAccountsTemplate"
  ></lib-tooltip>
</ng-template>

<ng-template #selectedAccountsTemplate>
  <div class="accounts-list-head">({{ companyDetails.length }}) Accounts</div>
  <ul class="accounts-list-body">
    <li class="nowrap" *ngFor="let company of companyDetails">{{ company?.name }}</li>
  </ul>
</ng-template>
